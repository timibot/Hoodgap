/**
 * seed-liquidity.js â€” Seed the HoodGap pool with initial liquidity
 *
 * Works with both localhost (mints fresh USDC) and testnet (uses existing USDC).
 *
 * Usage:
 *   npx hardhat run scripts/seed-liquidity.js --network localhost
 *   npx hardhat run scripts/seed-liquidity.js --network robinhoodTestnet
 */

const hre = require("hardhat");
const fs = require("fs");
const path = require("path");

// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SEED_AMOUNT_USD = 100_000; // $100,000 initial liquidity
const USDC_DECIMALS = 6;
const toUSDC = (n) => BigInt(Math.round(n * 10 ** USDC_DECIMALS));
const fromUSDC = (n) => Number(n) / 10 ** USDC_DECIMALS;
const fmt = (n) => `$${fromUSDC(n).toLocaleString("en-US", { minimumFractionDigits: 2 })}`;

async function getAddresses() {
  // Try reading from frontend/.env.local first (auto-generated by deploy.js)
  const envPath = path.join(__dirname, "..", "frontend", ".env.local");
  if (fs.existsSync(envPath)) {
    const env = fs.readFileSync(envPath, "utf8");
    const match = (key) => {
      const m = env.match(new RegExp(`${key}=(.+)`));
      return m ? m[1].trim() : null;
    };
    const hoodgap = match("NEXT_PUBLIC_HOODGAP_ADDRESS");
    const usdc = match("NEXT_PUBLIC_USDC_ADDRESS");
    if (hoodgap && usdc) return { hoodgap, usdc };
  }

  // Fallback: try .env
  if (process.env.HOODGAP_ADDRESS_TESTNET && process.env.USDC_ADDRESS_TESTNET) {
    return {
      hoodgap: process.env.HOODGAP_ADDRESS_TESTNET,
      usdc: process.env.USDC_ADDRESS_TESTNET,
    };
  }

  throw new Error(
    "Cannot find contract addresses. Run deploy.js first, or set HOODGAP_ADDRESS_TESTNET and USDC_ADDRESS_TESTNET in .env"
  );
}

async function main() {
  console.log("\nðŸŒ± HoodGap â€” Seed Liquidity Script");
  console.log("   Network:", hre.network.name);
  console.log("â”€".repeat(50));

  const [signer] = await hre.ethers.getSigners();
  console.log("   Signer: ", signer.address);

  const { hoodgap: hoodgapAddr, usdc: usdcAddr } = await getAddresses();
  console.log("   HoodGap:", hoodgapAddr);
  console.log("   USDC:   ", usdcAddr);
  console.log("â”€".repeat(50));

  const hoodgap = await hre.ethers.getContractAt("HoodGap", hoodgapAddr);
  const usdc = await hre.ethers.getContractAt("MockUSDC", usdcAddr);

  const seedAmount = toUSDC(SEED_AMOUNT_USD);

  // Check existing balance
  const existingBalance = await usdc.balanceOf(signer.address);
  console.log(`\n  Current USDC balance: ${fmt(existingBalance)}`);

  // Mint USDC if needed (works on any network with our MockUSDC)
  if (existingBalance < seedAmount) {
    const mintAmount = seedAmount - existingBalance;
    console.log(`  Minting ${fmt(mintAmount)} USDC...`);
    const mintTx = await usdc.mint(signer.address, mintAmount);
    await mintTx.wait();
    console.log("  âœ… Minted");
  }

  // Check existing stake
  const existingStake = await hoodgap.stakerBalances(signer.address);
  if (existingStake > 0n) {
    console.log(`\n  âš ï¸  Already staked: ${fmt(existingStake)}`);
  }

  // Approve & stake
  console.log(`\n  Approving ${fmt(seedAmount)} USDC...`);
  const approveTx = await usdc.approve(hoodgapAddr, seedAmount);
  await approveTx.wait();
  console.log("  âœ… Approved");

  console.log(`  Staking ${fmt(seedAmount)}...`);
  const stakeTx = await hoodgap.stake(seedAmount);
  await stakeTx.wait();
  console.log("  âœ… Staked");

  // Verify & display pool stats
  const stats = await hoodgap.getPoolStats();
  console.log("\n  ðŸ“Š Pool Stats:");
  console.log(`     Total Staked:    ${fmt(stats[0])}`);
  console.log(`     Total Coverage:  ${fmt(stats[1])}`);
  console.log(`     Utilization:     ${Number(stats[2]) / 100}%`);
  console.log(`     Reserve:         ${fmt(stats[3])}`);
  console.log(`     Active Policies: ${stats[4]}`);

  // Approve settlement for current week (if guardian)
  const owner = await hoodgap.owner();
  if (signer.address.toLowerCase() === owner.toLowerCase()) {
    const week = await hoodgap.getCurrentSettlementWeek();
    const [approved] = await hoodgap.canSettle(week);
    if (!approved) {
      console.log(`\n  ðŸ›¡ï¸  Approving settlement for week ${week}...`);
      await hoodgap.approveSettlement(week, 10000, "Initial seed â€” no split");
      console.log("  âœ… Settlement approved (1.0x ratio)");
    }
  }

  console.log("\n  ðŸŽ¯ Pool is ready! Start the frontend:");
  console.log("     cd frontend && npm run dev\n");
}

main().catch((error) => {
  console.error(error);
  process.exitCode = 1;
});
